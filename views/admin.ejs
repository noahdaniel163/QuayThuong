<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã - Quay Th∆∞·ªüng</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß QU·∫¢N TR·ªä QUAY TH∆Ø·ªûNG</h1>
            <nav>
                <a href="/" class="nav-link">üè† Trang ch·ªß</a>
                <a href="/admin/export" class="nav-link export-btn">üìä Xu·∫•t Excel</a>
            </nav>
        </header>

        <!-- Th√¥ng b√°o -->
        <div class="alerts">
            <script>
                const urlParams = new URLSearchParams(window.location.search);
                const message = urlParams.get('message');
                
                if (urlParams.get('success') === 'upload') {
                    const msg = message ? decodeURIComponent(message) : 'Upload file Excel th√†nh c√¥ng!';
                    document.write('<div class="alert success">‚úÖ ' + msg.replace(/\n/g, '<br>') + '</div>');
                } else if (urlParams.get('success') === 'save') {
                    document.write('<div class="alert success">‚úÖ L∆∞u nh√¢n vi√™n th√†nh c√¥ng!</div>');
                } else if (urlParams.get('success') === 'delete') {
                    document.write('<div class="alert success">‚úÖ X√≥a nh√¢n vi√™n th√†nh c√¥ng!</div>');
                } else if (urlParams.get('success') === 'reset') {
                    document.write('<div class="alert success">‚úÖ Reset tr·∫°ng th√°i th√†nh c√¥ng!</div>');
                } else if (urlParams.get('error')) {
                    const msg = message ? decodeURIComponent(message) : 'C√≥ l·ªói x·∫£y ra!';
                    document.write('<div class="alert error">‚ùå ' + msg.replace(/\n/g, '<br>') + '</div>');
                }
            </script>
        </div>

        <main>
            <!-- C·∫•u h√¨nh s·ª± ki·ªán -->
            <section class="config-section">
                <h2>üé® C·∫•u H√¨nh Giao Di·ªán S·ª± Ki·ªán</h2>
                <form action="/admin/config" method="post" class="config-form">
                    <div class="config-tabs">
                        <button type="button" class="tab-btn active" data-tab="basic">C∆° b·∫£n</button>
                        <button type="button" class="tab-btn" data-tab="background">·∫¢nh n·ªÅn</button>
                        <button type="button" class="tab-btn" data-tab="colors">M√†u s·∫Øc</button>
                        <button type="button" class="tab-btn" data-tab="display">Hi·ªÉn th·ªã</button>
                        <button type="button" class="tab-btn" data-tab="effects">Hi·ªáu ·ª©ng</button>
                    </div>

                    <div class="tab-content" id="basic">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="event_title">Ti√™u ƒë·ªÅ s·ª± ki·ªán:</label>
                                <input type="text" id="event_title" name="event_title" 
                                       value="<%= config.event_title || 'QUAY TH∆Ø·ªûNG N·ªòI B·ªò' %>" 
                                       placeholder="QUAY TH∆Ø·ªûNG N·ªòI B·ªò" required>
                            </div>
                            <div class="form-group">
                                <label for="event_subtitle">Ph·ª• ƒë·ªÅ:</label>
                                <input type="text" id="event_subtitle" name="event_subtitle" 
                                       value="<%= config.event_subtitle || 'Ch√∫c m·ª´ng nh·ªØng ng∆∞·ªùi may m·∫Øn!' %>" 
                                       placeholder="Ch√∫c m·ª´ng nh·ªØng ng∆∞·ªùi may m·∫Øn!">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="logo_url">URL Logo (t√πy ch·ªçn):</label>
                            <input type="url" id="logo_url" name="logo_url" 
                                   value="<%= config.logo_url || '' %>" 
                                   placeholder="https://example.com/logo.png">
                        </div>
                    </div>

                    <div class="tab-content" id="background" style="display: none;">
                        <div class="background-section">
                            <h3>üñºÔ∏è C·∫•u H√¨nh ·∫¢nh N·ªÅn</h3>
                            
                            <!-- URL ·∫¢nh N·ªÅn -->
                            <div class="form-group">
                                <label for="background_image_url">URL ·∫¢nh N·ªÅn:</label>
                                <input type="url" id="background_image_url" name="background_image" 
                                       value="<%= config.background_image || '' %>" 
                                       placeholder="https://example.com/background.jpg"
                                       onchange="previewBackgroundUrl(this.value)">
                                <p class="help-text">
                                    üìå Nh·∫≠p URL ·∫£nh n·ªÅn t·ª´ internet (JPG, PNG, WEBP)<br>
                                    üéØ Khuy·∫øn ngh·ªã: 1920x1080px (Full HD) ho·∫∑c cao h∆°n
                                </p>
                            </div>

                            <!-- Preview ·∫¢nh N·ªÅn -->
                            <div class="background-preview" id="backgroundPreview">
                                <% if (config.background_image) { %>
                                    <img src="<%= config.background_image %>" alt="Background Preview" class="preview-image">
                                    <button type="button" class="btn btn-warning" onclick="removeBackground()">üóëÔ∏è X√≥a ·∫£nh n·ªÅn</button>
                                <% } else { %>
                                    <div class="no-background">
                                        <p>Ch∆∞a c√≥ ·∫£nh n·ªÅn. Nh·∫≠p URL ·∫£nh ƒë·ªÉ xem tr∆∞·ªõc.</p>
                                    </div>
                                <% } %>
                            </div>

                            <!-- C·∫•u h√¨nh ·∫¢nh N·ªÅn -->
                            <div class="background-settings">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="background_position">V·ªã tr√≠ ·∫£nh n·ªÅn:</label>
                                        <select id="background_position" name="background_position">
                                            <option value="center" <%= config.background_position === 'center' || !config.background_position ? 'selected' : '' %>>Gi·ªØa</option>
                                            <option value="top" <%= config.background_position === 'top' ? 'selected' : '' %>>Tr√™n</option>
                                            <option value="bottom" <%= config.background_position === 'bottom' ? 'selected' : '' %>>D∆∞·ªõi</option>
                                            <option value="left" <%= config.background_position === 'left' ? 'selected' : '' %>>Tr√°i</option>
                                            <option value="right" <%= config.background_position === 'right' ? 'selected' : '' %>>Ph·∫£i</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="background_size">K√≠ch th∆∞·ªõc ·∫£nh n·ªÅn:</label>
                                        <select id="background_size" name="background_size">
                                            <option value="cover" <%= config.background_size === 'cover' || !config.background_size ? 'selected' : '' %>>Ph·ªß ƒë·∫ßy (Cover)</option>
                                            <option value="contain" <%= config.background_size === 'contain' ? 'selected' : '' %>>V·ª´a khung (Contain)</option>
                                            <option value="100% 100%" <%= config.background_size === '100% 100%' ? 'selected' : '' %>>K√©o gi√£n ƒë·∫ßy</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="background_opacity">ƒê·ªô m·ªù overlay (0-100%):</label>
                                    <input type="range" id="background_opacity" name="background_opacity" 
                                           min="0" max="100" value="<%= config.background_opacity || '30' %>"
                                           oninput="updateOpacityValue(this.value)">
                                    <span id="opacityValue"><%= config.background_opacity || '30' %>%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="colors" style="display: none;">
                        <!-- Gradient Background Section -->
                        <div class="gradient-section">
                            <h3>üåà M√†u N·ªÅn Gradient</h3>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="use_gradient" name="use_gradient" value="true"
                                           <%= config.use_gradient === 'true' ? 'checked' : '' %>
                                           onchange="toggleGradientOptions(this.checked)">
                                    S·ª≠ d·ª•ng m√†u n·ªÅn gradient thay v√¨ m√†u ƒë∆°n
                                </label>
                            </div>
                            
                            <div class="gradient-options" id="gradientOptions" style="display: <%= config.use_gradient === 'true' ? 'block' : 'none' %>;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gradient_color1">M√†u gradient 1:</label>
                                        <div class="color-input-group">
                                            <input type="color" id="gradient_color1" name="gradient_color1" 
                                                   value="<%= config.gradient_color1 || '#667eea' %>">
                                            <input type="text" class="color-text" 
                                                   value="<%= config.gradient_color1 || '#667eea' %>">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="gradient_color2">M√†u gradient 2:</label>
                                        <div class="color-input-group">
                                            <input type="color" id="gradient_color2" name="gradient_color2" 
                                                   value="<%= config.gradient_color2 || '#764ba2' %>">
                                            <input type="text" class="color-text" 
                                                   value="<%= config.gradient_color2 || '#764ba2' %>">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="gradient_direction">H∆∞·ªõng gradient:</label>
                                        <select id="gradient_direction" name="gradient_direction">
                                            <option value="to right" <%= config.gradient_direction === 'to right' || !config.gradient_direction ? 'selected' : '' %>>Ngang (tr√°i ‚Üí ph·∫£i)</option>
                                            <option value="to left" <%= config.gradient_direction === 'to left' ? 'selected' : '' %>>Ngang (ph·∫£i ‚Üí tr√°i)</option>
                                            <option value="to bottom" <%= config.gradient_direction === 'to bottom' ? 'selected' : '' %>>D·ªçc (tr√™n ‚Üí d∆∞·ªõi)</option>
                                            <option value="to top" <%= config.gradient_direction === 'to top' ? 'selected' : '' %>>D·ªçc (d∆∞·ªõi ‚Üí tr√™n)</option>
                                            <option value="45deg" <%= config.gradient_direction === '45deg' ? 'selected' : '' %>>Ch√©o (45¬∞)</option>
                                            <option value="135deg" <%= config.gradient_direction === '135deg' ? 'selected' : '' %>>Ch√©o (135¬∞)</option>
                                            <option value="radial" <%= config.gradient_direction === 'radial' ? 'selected' : '' %>>Tr√≤n (t·ª´ gi·ªØa)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="gradient_opacity">ƒê·ªô m·ªù gradient (0-100%):</label>
                                        <input type="range" id="gradient_opacity" name="gradient_opacity" 
                                               min="0" max="100" value="<%= config.gradient_opacity || '80' %>"
                                               oninput="updateGradientOpacityValue(this.value)">
                                        <span id="gradientOpacityValue"><%= config.gradient_opacity || '80' %>%</span>
                                    </div>
                                </div>
                                
                                <!-- Gradient Preview -->
                                <div class="gradient-preview" id="gradientPreview">
                                    <div class="preview-box" style="background: linear-gradient(<%= config.gradient_direction || 'to right' %>, <%= config.gradient_color1 || '#667eea' %>, <%= config.gradient_color2 || '#764ba2' %>); opacity: <%= (config.gradient_opacity || 80) / 100 %>;"></div>
                                    <p>Xem tr∆∞·ªõc gradient</p>
                                </div>
                            </div>
                        </div>

                        <!-- Regular Colors Section -->
                        <div class="regular-colors-section">
                            <h3>üé® M√†u S·∫Øc Giao Di·ªán</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="primary_color">M√†u ch√≠nh:</label>
                                    <div class="color-input-group">
                                        <input type="color" id="primary_color" name="primary_color" 
                                               value="<%= config.primary_color || '#4CAF50' %>">
                                        <input type="text" class="color-text" 
                                               value="<%= config.primary_color || '#4CAF50' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="secondary_color">M√†u ph·ª•:</label>
                                    <div class="color-input-group">
                                        <input type="color" id="secondary_color" name="secondary_color" 
                                               value="<%= config.secondary_color || '#FFC107' %>">
                                        <input type="text" class="color-text" 
                                               value="<%= config.secondary_color || '#FFC107' %>">
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" id="backgroundColorGroup" style="display: <%= config.use_gradient === 'true' ? 'none' : 'block' %>;">
                                    <label for="background_color">M√†u n·ªÅn:</label>
                                    <div class="color-input-group">
                                        <input type="color" id="background_color" name="background_color" 
                                               value="<%= config.background_color || '#1a1a1a' %>">
                                        <input type="text" class="color-text" 
                                               value="<%= config.background_color || '#1a1a1a' %>">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="text_color">M√†u ch·ªØ:</label>
                                    <div class="color-input-group">
                                        <input type="color" id="text_color" name="text_color" 
                                               value="<%= config.text_color || '#ffffff' %>">
                                        <input type="text" class="color-text" 
                                               value="<%= config.text_color || '#ffffff' %>">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="display" style="display: none;">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="show_winner_list" value="true" 
                                       <%= config.show_winner_list === 'true' ? 'checked' : '' %>>
                                Hi·ªÉn th·ªã danh s√°ch ng∆∞·ªùi tr√∫ng th∆∞·ªüng
                            </label>
                        </div>
                    </div>

                    <div class="tab-content" id="effects" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="animation_speed">T·ªëc ƒë·ªô animation:</label>
                                <select id="animation_speed" name="animation_speed">
                                    <option value="slow" <%= config.animation_speed === 'slow' ? 'selected' : '' %>>Ch·∫≠m (5s)</option>
                                    <option value="normal" <%= config.animation_speed === 'normal' || !config.animation_speed ? 'selected' : '' %>>B√¨nh th∆∞·ªùng (3s)</option>
                                    <option value="fast" <%= config.animation_speed === 'fast' ? 'selected' : '' %>>Nhanh (2s)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="sound_enabled" value="true" 
                                           <%= config.sound_enabled === 'true' ? 'checked' : '' %>>
                                    B·∫≠t hi·ªáu ·ª©ng √¢m thanh
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="config-actions">
                        <button type="submit" class="btn btn-primary">üíæ L∆∞u c·∫•u h√¨nh</button>
                        <a href="/" target="_blank" class="btn btn-secondary">üëÄ Xem tr∆∞·ªõc</a>
                        <button type="button" class="btn btn-warning" onclick="resetConfig()">üîÑ Reset m·∫∑c ƒë·ªãnh</button>
                    </div>
                </form>
            </section>

            <!-- Upload Excel -->
            <section class="upload-section">
                <h2>üìÅ Upload Danh S√°ch Nh√¢n Vi√™n</h2>
                <form action="/admin/upload" method="post" enctype="multipart/form-data" class="upload-form">
                    <div class="file-input-wrapper">
                        <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls" required>
                        <label for="excelFile" class="file-input-label">Ch·ªçn file Excel</label>
                    </div>
                    <button type="submit" class="btn btn-primary">üì§ Upload</button>
                </form>
                <p class="help-text">
                    File Excel c·∫ßn c√≥ c√°c c·ªôt: <strong>M√£ s·ªë nh√¢n vi√™n</strong>, <strong>T√™n nh√¢n vi√™n</strong>, <strong>Ph√≤ng ban</strong>
                </p>
            </section>

            <!-- Th√™m nh√¢n vi√™n m·ªõi -->
            <section class="add-employee-section">
                <h2>üë§ Th√™m Nh√¢n Vi√™n M·ªõi</h2>
                <form action="/admin/employee" method="post" class="employee-form">
                    <div class="form-row">
                        <input type="text" name="ma_so_nhan_vien" placeholder="M√£ s·ªë nh√¢n vi√™n" required>
                        <input type="text" name="ten_nhan_vien" placeholder="T√™n nh√¢n vi√™n" required>
                        <input type="text" name="phong_ban" placeholder="Ph√≤ng ban" required>
                        <button type="submit" class="btn btn-success">‚ûï Th√™m</button>
                    </div>
                </form>
            </section>

            <!-- Reset v√† th·ªëng k√™ -->
            <section class="controls-section">
                <div class="stats-row">
                    <div class="stat-card">
                        <h3>T·ªïng nh√¢n vi√™n</h3>
                        <span class="stat-number"><%= employees.length %></span>
                    </div>
                    <div class="stat-card">
                        <h3>ƒê√£ tr√∫ng th∆∞·ªüng</h3>
                        <span class="stat-number"><%= employees.filter(emp => emp.da_trung).length %></span>
                    </div>
                    <div class="stat-card">
                        <h3>Ch∆∞a tr√∫ng</h3>
                        <span class="stat-number"><%= employees.filter(emp => !emp.da_trung).length %></span>
                    </div>
                </div>
                <div class="control-buttons">
                    <form action="/admin/reset" method="post" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën reset t·∫•t c·∫£ tr·∫°ng th√°i quay th∆∞·ªüng?')" style="display: inline;">
                        <button type="submit" class="btn btn-warning">üîÑ Reset Tr·∫°ng Th√°i</button>
                    </form>
                    
                    <!-- N√∫t x√≥a to√†n b·ªô danh s√°ch nh√¢n vi√™n -->
                    <button type="button" class="btn btn-danger" onclick="showClearEmployeesModal()">üóëÔ∏è X√≥a To√†n B·ªô Danh S√°ch</button>
                </div>
            </section>

            <!-- Modal x√°c nh·∫≠n x√≥a to√†n b·ªô danh s√°ch -->
            <div id="clearEmployeesModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ö†Ô∏è X√°c Nh·∫≠n X√≥a To√†n B·ªô Danh S√°ch</h3>
                        <span class="close" onclick="hideClearEmployeesModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p><strong>C·∫¢NH B√ÅO:</strong> Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô danh s√°ch nh√¢n vi√™n v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!</p>
                        <p>ƒê·ªÉ x√°c nh·∫≠n, vui l√≤ng nh·∫≠p: <code>DELETE_ALL_EMPLOYEES</code></p>
                        <form id="clearEmployeesForm" action="/admin/clear-employees" method="post">
                            <input type="text" id="confirmInput" name="confirm" placeholder="Nh·∫≠p m√£ x√°c nh·∫≠n..." required autocomplete="off">
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideClearEmployeesModal()">H·ªßy</button>
                                <button type="submit" class="btn btn-danger" id="confirmClearBtn" disabled>X√≥a To√†n B·ªô</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch nh√¢n vi√™n -->
            <section class="employees-section">
                <h2>üë• Danh S√°ch Nh√¢n Vi√™n (<%= employees.length %>)</h2>
                <div class="table-wrapper">
                    <table class="employees-table">
                        <thead>
                            <tr>
                                <th>M√£ s·ªë</th>
                                <th>T√™n nh√¢n vi√™n</th>
                                <th>Ph√≤ng ban</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (employees.length === 0) { %>
                                <tr>
                                    <td colspan="5" class="no-data">Ch∆∞a c√≥ nh√¢n vi√™n n√†o</td>
                                </tr>
                            <% } else { %>
                                <% employees.forEach(employee => { %>
                                    <tr class="employee-row" data-id="<%= employee.id %>">
                                        <td class="editable" data-field="ma_so_nhan_vien"><%= employee.ma_so_nhan_vien %></td>
                                        <td class="editable" data-field="ten_nhan_vien"><%= employee.ten_nhan_vien %></td>
                                        <td class="editable" data-field="phong_ban"><%= employee.phong_ban %></td>
                                        <td>
                                            <span class="status <%= employee.da_trung ? 'won' : 'pending' %>">
                                                <%= employee.da_trung ? 'üèÜ ƒê√£ tr√∫ng' : '‚è≥ Ch∆∞a tr√∫ng' %>
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-edit" data-employee-id="<%= employee.id %>" onclick="editEmployee(this.dataset.employeeId)">‚úèÔ∏è</button>
                                            <button class="btn btn-sm btn-save" data-employee-id="<%= employee.id %>" onclick="saveEmployee(this.dataset.employeeId)" style="display:none">üíæ</button>
                                            <button class="btn btn-sm btn-cancel" data-employee-id="<%= employee.id %>" onclick="cancelEdit(this.dataset.employeeId)" style="display:none">‚ùå</button>
                                            <form style="display:inline" action="/admin/employee/delete" method="post" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n n√†y?')">
                                                <input type="hidden" name="id" value="<%= employee.id %>">
                                                <button type="submit" class="btn btn-sm btn-delete">üóëÔ∏è</button>
                                            </form>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="/js/admin.js"></script>
</body>
</html>